namespace = inheritance_lens

character_event = {
    id = inheritance_lens.001
    is_triggered_only = yes

    immediate = {
        if = {
            limit = { has_character_flag = inheritance_lens_cache_ready }
            clear_character_flag = inheritance_lens_cache_ready
        }
        clear_character_array = inheritance_lens_preview_entries
        set_character_variable = {
            name = inheritance_lens_cache_generation_seen
            value = global_variable:inheritance_lens_cache_generation
        }
        every_title = {
            limit = {
                OR = {
                    has_title_flag = inheritance_lens_recent_grant
                    has_title_flag = inheritance_lens_recent_revoke
                    has_title_flag = inheritance_lens_recent_law_change
                    has_title_flag = inheritance_lens_recent_election_update
                }
            }
            clear_title_flag = inheritance_lens_recent_grant
            clear_title_flag = inheritance_lens_recent_revoke
            clear_title_flag = inheritance_lens_recent_law_change
            clear_title_flag = inheritance_lens_recent_election_update
        }
    }
}

character_event = {
    id = inheritance_lens.100
    is_triggered_only = yes

    immediate = {
        save_scope_as = inheritance_lens_preview_title
        if = {
            limit = { scope:inheritance_lens_preview_title = { has_title = yes } }
            scope:inheritance_lens_root_character = {
                save_scope_as = inheritance_lens_preview_holder
            }
        }
    }

    option = {
        name = inheritance_lens_preview_option
        trigger = { always = yes }
        custom_tooltip = { text = INHERITANCE_LENS_PREVIEW_TOOLTIP }
        hidden_effect = {
            # Placeholder: In real implementation, evaluate succession law for scope:inheritance_lens_preview_title.
            scope:inheritance_lens_root_character = {
                add_character_array_element = {
                    name = inheritance_lens_preview_entries
                    value = {
                        title = scope:inheritance_lens_preview_title
                        heir = scope:inheritance_lens_preview_title.heir
                        succession_law = scope:inheritance_lens_preview_title.active_succession_law
                        warning_loc = INHERITANCE_LENS_PREVIEW_WARNING_NONE
                        tooltip_loc = INHERITANCE_LENS_PREVIEW_TOOLTIP_NONE
                    }
                }
            }
        }
    }
}

character_event = {
    id = inheritance_lens.200
    is_triggered_only = yes

    immediate = {
        if = {
            limit = { has_game_rule = { rule = inheritance_lens_refresh_mode option = periodic } }
            trigger_event = { id = inheritance_lens.001 days = 0 }
            inheritance_lens_calculate_preview_effect = yes
        }
    }
}
